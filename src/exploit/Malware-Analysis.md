---
title: Malware Analysis
description: 
tags:
    - Malware
refs:
date: 2022-12-26
draft: false
---

## Build a Sandbox

Before analyzing malware, it’s recommended to build a sandbox for malware analysis.  
Below are useful tools for building such an environment.

- **[FLARE VM](https://github.com/mandiant/flare-vm)**
    
    It is a collection of software installations scripts for Windows systems to maintain a reverse engineering environment on a virtual machine.

### Online Sandboxes

- **[ANY.RUN](https://any.run/)**
- **[Hybrid Analysis](https://hybrid-analysis.com/)**

<br />

## Analysis Tools

### Online

- **[Online Malware Analysis Sandbox](https://app.any.run/)**

    Cloud-based malware analysis service.

- **[VirusTotal](https://www.virustotal.com/gui/home/upload)**

        Analyse suspicious files, domains, IPs and URLs to detect malware and other breaches, automatically share them with the security community.

### Softwares

- **[Process Hacker](https://processhacker.sourceforge.io/)**

    It monitors system resources, debug software and detect malware.

### Programs

- **[Yara](https://github.com/virustotal/yara)**

    The pattern matching swiss knife for malware researchers.

    - **Automation Tools**

        - **[Loki](https://github.com/Neo23x0/Loki)**

            ```sh
            # Update first, then will add `signature-base` directory
            python ~/Loki/loki.py --update

            # Run
            python ~/Loki/loki.py -p ./suspicious_files_dir

            # Run & output a log file
            python loki.py -p ./suspicious_files_dir -l log.txt
            ```

        - **[yarGen](https://github.com/Neo23x0/yarGen)**

            ```sh
            # Update first
            python ~/yarGen/yarGen.py --update

            # Generate Yara ruls for specific file
            python ~/yarGen/yarGen.py -m ./suspicious_files_dir --excludegood -o ./suspicious_files_dir/rule.yar

            # Check if the file flagged
            yara ./suspicious_files_dir/rule.yar ./suspicious_files_dir/somefile.php

            # If flagged, copy this ruls to Loki's signature yara directory
            cp ./suspicious_files_dir/rule.yar ~/Loki/signature-base/yara

            # Then run Loki
            # ...
            ```

    - **Manual**

        - **Find Files Matches Rules**

            ```sh
            yara rule.yar ./somedir
            # Print only number of matches
            yara -c rule.yar ./somedir
            # Print only not satisfied rules 
            yara -n rule.yar ./somedir
            # Print metadata
            yara -m rule.yar ./somedir
            ```

        - **Create Rules**

            Create "rule.yar".

            ```txt
            rule rule_name {
                meta:
                    author = "pentester"
                    description = "test rule"
                    created = "6/20/2022 00:00"
                strings:
                    $hello = "Hello"
                    $text_file = ".txt"
                condition:
                    $hello and $text_file
            }
            ```       

<br />

## Static Analysis

Static Analysis is a method of malware analysis that analyze without executing a suspicious file. It can detect basic information (e.g. packer, linker, architecture) of files but may be not enough.

- **[Detect It Easy](https://github.com/horsicq/Detect-It-Easy)**
    
    It determines types of files.
    
- **[CAPA](https://github.com/mandiant/capa](https://github.com/mandiant/capa)**
    
    It identifies capabilities in executable files.
    
    ```sh
    capa ./executable
    ```
    

If you found that the executable is packed with a packer tool such as UPX, unpack with the same packer tool and re-analyze the file using CAPA.  
For example, if the executable is packed with UPX, unpack with UPX and re-run capa.

```sh
upx -d ./executable
# Delete the cache of capa
del ./executable.viv
capa <suspicious-executable>
```

<br />

## Dynamic Analysis

If our environment is Windows, we need to start the Process Monitor before running the dynamic analysis.  
[Process Monitor (ProcMon)](https://learn.microsoft.com/en-us/sysinternals/downloads/procmon) is a Windows tool that analyze the behavior (real-time registry, file system, and process/threat activity) while analyzing malware.  

In ProcMon, set “Process Name” “is” “executable.exe” then “Include” in the Process Monitor Filter, and click “Add” → “OK”.  

After executing, you should see results appear in the ProcMon.  
The first step is to unset all filters on the right of the tool bar, then set again a filter one by one.

- Show Registry Activity
    
    This filter allows us to determine if any significant Registry Modifications are executed by the binary.  To focus on Registry Key Creations and Modifications, exclude RegOpenKey, RegQueryValue, RegQueryKey, RegCloseKey by right-clicking on the row of results.
    
- Show File System Activity
    
    This filter allows us to determint if the malware executes File Creations. To focus only on File Write events, exclude CreateFile, CreateFileMapping, QuerySecurityFile, QueryNameInformationFile, QueryBasicInformationFile, CloseFile, ReadFile.
    
- Show Network Activity
    
    This filter allows us to confirm if the malware attempts to make a network connection.

<br />

## Malicious Document (.doc) Analysis

1. Open CyberChef
2. Upload the suspicious doc file on CyberChef.
3. Use the “Strings” function to extract strings.
4. If you found obfuscated strings in the results, add the “Find / Replace” function to remove extra strings.
5. If necessary, add the “Drop bytes” function to remove extra bytes.

<br />

## Attack with Malware

### Programs

- **[Reptile](https://github.com/f0rb1dd3n/Reptile)**

    LKM Linux rootkit.
